name: "Ready Image on secure Power Virtual Servers"
# yaml-language-server: $schema=https://raw.githubusercontent.com/Cloud-Schematics/vscode-blueprint-schema/master/blueprint_schema.json
schema_version: "1.0.0"
description: "Solution to deploy Ready Image on secure Power Virtual Servers"
type: "blueprint"
inputs:
  - name: override_json_string
    description: Over rides default values with custom json
    type: string
    optional: true
    default: |
      {
      "access_groups": [],
      "appid": {
        "keys": [
          "slz-appid-key"
        ],
        "name": "slz-appid",
        "resource_group": "slz-service-rg",
        "use_appid": false,
        "use_data": false
      },
      "clusters": [],
      "enable_transit_gateway": true,
      "transit_gateway_connections": [
        "management",
        "workload",
        "edge"
      ],
      "transit_gateway_resource_group": "slz-service-rg",
      "virtual_private_endpoints": [
        {
          "resource_group": "slz-service-rg",
          "service_name": "cos",
          "service_type": "cloud-object-storage",
          "vpcs": [
            {
              "name": "management",
              "subnets": [
                "vpe-zone-1"
              ]
            },
            {
              "name": "workload",
              "subnets": [
                "vpe-zone-1"
              ]
            }
          ]
        }
      ],
      "service_endpoints": "private",
      "security_groups": [],
      "vpn_gateways": [
        {
          "connections": [],
          "name": "management-gateway",
          "resource_group": "slz-management-rg",
          "subnet_name": "vpn-zone-1",
          "vpc_name": "management"
        }
      ],
      "atracker": {
        "collector_bucket_name": "atracker-bucket",
        "receive_global_events": true,
        "resource_group": "slz-service-rg",
        "add_route": true
      },
      "cos": [
        {
          "buckets": [
            {
              "endpoint_type": "public",
              "force_delete": true,
              "kms_key": "slz-atracker-key",
              "name": "atracker-bucket",
              "storage_class": "standard"
            }
          ],
          "keys": [
            {
              "name": "cos-bind-key",
              "role": "Writer",
              "enable_HMAC": false
            }
          ],
          "name": "atracker-cos",
          "plan": "standard",
          "random_suffix": true,
          "resource_group": "slz-service-rg",
          "use_data": false
        },
        {
          "buckets": [
            {
              "endpoint_type": "public",
              "force_delete": true,
              "kms_key": "slz-key",
              "name": "management-bucket",
              "storage_class": "standard"
            },
            {
              "endpoint_type": "public",
              "force_delete": true,
              "kms_key": "slz-key",
              "name": "workload-bucket",
              "storage_class": "standard"
            },
            {
              "endpoint_type": "public",
              "force_delete": true,
              "kms_key": "slz-key",
              "name": "edge-bucket",
              "storage_class": "standard"
            }
          ],
          "keys": [],
          "name": "cos",
          "plan": "standard",
          "random_suffix": true,
          "resource_group": "slz-service-rg",
          "use_data": false
        }
      ],
      "iam_account_settings": {
        "enable": false
      },
      "key_management": {
        "keys": [
          {
            "key_ring": "slz-slz-ring",
            "name": "slz-key",
            "root_key": true
          },
          {
            "key_ring": "slz-slz-ring",
            "name": "slz-atracker-key",
            "root_key": true
          },
          {
            "key_ring": "slz-slz-ring",
            "name": "slz-vsi-volume-key",
            "root_key": true
          }
        ],
        "name": "slz-kms",
        "resource_group": "slz-service-rg",
        "use_hs_crypto": false
      },
      "resource_groups": [
        {
          "create": true,
          "name": "slz-service-rg",
          "use_prefix": true
        },
        {
          "create": true,
          "name": "slz-management-rg",
          "use_prefix": true
        },
        {
          "create": true,
          "name": "slz-workload-rg",
          "use_prefix": true
        },
        {
          "create": true,
          "name": "slz-edge-rg",
          "use_prefix": true
        }
      ],
      "secrets_manager": {
        "kms_key_name": null,
        "name": null,
        "resource_group": null,
        "use_secrets_manager": false
      },
      "network_cidr": "10.0.0.0/8",
      "vpcs": [
        {
          "address_prefixes": {
            "zone-1": [],
            "zone-2": [],
            "zone-3": []
          },
          "default_security_group_rules": [],
          "flow_logs_bucket_name": null,
          "network_acls": [
            {
              "name": "management-acl",
              "rules": [
                {
                  "action": "allow",
                  "destination": "10.0.0.0/8",
                  "direction": "inbound",
                  "name": "allow-ibm-inbound",
                  "source": "161.0.0.0/8"
                },
                {
                  "action": "allow",
                  "destination": "161.0.0.0/8",
                  "direction": "outbound",
                  "name": "allow-ibm-outbound",
                  "source": "10.0.0.0/8"
                },
                {
                  "action": "allow",
                  "destination": "10.10.10.0/24",
                  "direction": "inbound",
                  "name": "allow-ssh-inbound",
                  "source": "0.0.0.0/0",
                  "tcp": {
                    "port_max": 22,
                    "port_min": 22
                  }
                },
                {
                  "action": "allow",
                  "destination": "0.0.0.0/0",
                  "direction": "outbound",
                  "name": "allow-ssh-outbound",
                  "source": "10.10.10.0/24",
                  "tcp": {
                    "source_port_max": 22,
                    "source_port_min": 22
                  }
                },
                {
                  "action": "allow",
                  "destination": "10.0.0.0/8",
                  "direction": "inbound",
                  "name": "allow-all-network-inbound",
                  "source": "10.0.0.0/8"
                },
                {
                  "action": "allow",
                  "destination": "10.0.0.0/8",
                  "direction": "outbound",
                  "name": "allow-all-network-outbound",
                  "source": "10.0.0.0/8"
                },
                {
                  "action": "deny",
                  "destination": "0.0.0.0/0",
                  "direction": "inbound",
                  "name": "default-deny-inbound",
                  "source": "0.0.0.0/0"
                },
                {
                  "action": "deny",
                  "destination": "0.0.0.0/0",
                  "direction": "outbound",
                  "name": "default-deny-outbound",
                  "source": "0.0.0.0/0"
                }
              ]
            }
          ],
          "prefix": "management",
          "resource_group": "slz-management-rg",
          "subnets": {
            "zone-1": [
              {
                "acl_name": "management-acl",
                "cidr": "10.10.10.0/24",
                "name": "vsi-zone-1",
                "public_gateway": false
              },
              {
                "acl_name": "management-acl",
                "cidr": "10.10.20.0/24",
                "name": "vpe-zone-1",
                "public_gateway": false
              },
              {
                "acl_name": "management-acl",
                "cidr": "10.10.30.0/24",
                "name": "vpn-zone-1",
                "public_gateway": false
              }
            ],
            "zone-2": null,
            "zone-3": null
          },
          "use_public_gateways": {
            "zone-1": false,
            "zone-2": false,
            "zone-3": false
          }
        },
        {
          "address_prefixes": {
            "zone-1": [],
            "zone-2": [],
            "zone-3": []
          },
          "default_security_group_rules": [],
          "flow_logs_bucket_name": null,
          "network_acls": [
            {
              "name": "workload-acl",
              "rules": [
                {
                  "action": "allow",
                  "destination": "10.0.0.0/8",
                  "direction": "inbound",
                  "name": "allow-ibm-inbound",
                  "source": "161.0.0.0/8"
                },
                {
                  "action": "allow",
                  "destination": "161.0.0.0/8",
                  "direction": "outbound",
                  "name": "allow-ibm-outbound",
                  "source": "10.0.0.0/8"
                },
                {
                  "action": "allow",
                  "destination": "10.0.0.0/8",
                  "direction": "inbound",
                  "name": "allow-dns-inbound",
                  "source": "0.0.0.0/0",
                  "udp": {
                    "source_port_max": 53,
                    "source_port_min": 53
                  }
                },
                {
                  "action": "allow",
                  "destination": "0.0.0.0/0",
                  "direction": "outbound",
                  "name": "allow-dns-outbound",
                  "source": "10.0.0.0/8",
                  "udp": {
                    "port_max": 53,
                    "port_min": 53
                  }
                },
                {
                  "action": "allow",
                  "destination": "10.0.0.0/8",
                  "direction": "inbound",
                  "name": "allow-all-network-inbound",
                  "source": "10.0.0.0/8"
                },
                {
                  "action": "allow",
                  "destination": "10.0.0.0/8",
                  "direction": "outbound",
                  "name": "allow-all-network-outbound",
                  "source": "10.0.0.0/8"
                },
                {
                  "action": "deny",
                  "destination": "0.0.0.0/0",
                  "direction": "inbound",
                  "name": "default-deny-inbound",
                  "source": "0.0.0.0/0"
                },
                {
                  "action": "deny",
                  "destination": "0.0.0.0/0",
                  "direction": "outbound",
                  "name": "default-deny-outbound",
                  "source": "0.0.0.0/0"
                }
              ]
            }
          ],
          "prefix": "workload",
          "resource_group": "slz-workload-rg",
          "subnets": {
            "zone-1": [
              {
                "acl_name": "workload-acl",
                "cidr": "10.20.10.0/24",
                "name": "vsi-zone-1",
                "public_gateway": true
              },
              {
                "acl_name": "workload-acl",
                "cidr": "10.20.20.0/24",
                "name": "vpe-zone-1",
                "public_gateway": false
              }
            ],
            "zone-2": null,
            "zone-3": null
          },
          "use_public_gateways": {
            "zone-1": false,
            "zone-2": false,
            "zone-3": false
          }
        },
        {
          "address_prefixes": {
            "zone-1": [],
            "zone-2": [],
            "zone-3": []
          },
          "default_security_group_rules": [],
          "flow_logs_bucket_name": null,
          "network_acls": [
            {
              "name": "edge-acl",
              "rules": [
                {
                  "action": "allow",
                  "destination": "10.0.0.0/8",
                  "direction": "inbound",
                  "name": "allow-ibm-inbound",
                  "source": "161.0.0.0/8"
                },
                {
                  "action": "allow",
                  "destination": "161.0.0.0/8",
                  "direction": "outbound",
                  "name": "allow-ibm-outbound",
                  "source": "10.0.0.0/8"
                },
                {
                  "action": "allow",
                  "destination": "10.0.0.0/8",
                  "direction": "inbound",
                  "name": "allow-dns-inbound",
                  "source": "0.0.0.0/0",
                  "udp": {
                    "source_port_max": 53,
                    "source_port_min": 53
                  }
                },
                {
                  "action": "allow",
                  "destination": "0.0.0.0/0",
                  "direction": "outbound",
                  "name": "allow-dns-outbound",
                  "source": "10.0.0.0/8",
                  "udp": {
                    "port_max": 53,
                    "port_min": 53
                  }
                },
                {
                  "action": "allow",
                  "destination": "10.0.0.0/8",
                  "direction": "inbound",
                  "name": "allow-all-network-inbound",
                  "source": "10.0.0.0/8"
                },
                {
                  "action": "allow",
                  "destination": "10.0.0.0/8",
                  "direction": "outbound",
                  "name": "allow-all-network-outbound",
                  "source": "10.0.0.0/8"
                },
                {
                  "action": "allow",
                  "destination": "10.0.0.0/8",
                  "direction": "inbound",
                  "name": "allow-8443-inbound",
                  "source": "0.0.0.0/0",
                  "tcp": {
                    "source_port_max": 8443,
                    "source_port_min": 8443
                  }
                },
                {
                  "action": "allow",
                  "destination": "0.0.0.0/0",
                  "direction": "outbound",
                  "name": "allow-8443-outbound",
                  "source": "10.0.0.0/8",
                  "tcp": {
                    "port_max": 8443,
                    "port_min": 8443
                  }
                },
                {
                  "action": "allow",
                  "destination": "10.0.0.0/8",
                  "direction": "inbound",
                  "name": "allow-443-inbound",
                  "source": "0.0.0.0/0",
                  "tcp": {
                    "source_port_max": 443,
                    "source_port_min": 443
                  }
                },
                {
                  "action": "allow",
                  "destination": "0.0.0.0/0",
                  "direction": "outbound",
                  "name": "allow-443-outbound",
                  "source": "10.0.0.0/8",
                  "tcp": {
                    "port_max": 443,
                    "port_min": 443
                  }
                },
                {
                  "action": "allow",
                  "destination": "10.0.0.0/8",
                  "direction": "inbound",
                  "name": "allow-80-inbound",
                  "source": "0.0.0.0/0",
                  "tcp": {
                    "source_port_max": 80,
                    "source_port_min": 80
                  }
                },
                {
                  "action": "allow",
                  "destination": "0.0.0.0/0",
                  "direction": "outbound",
                  "name": "allow-80-outbound",
                  "source": "10.0.0.0/8",
                  "tcp": {
                    "port_max": 80,
                    "port_min": 80
                  }
                },
                {
                  "action": "deny",
                  "destination": "0.0.0.0/0",
                  "direction": "inbound",
                  "name": "default-deny-inbound",
                  "source": "0.0.0.0/0"
                },
                {
                  "action": "deny",
                  "destination": "0.0.0.0/0",
                  "direction": "outbound",
                  "name": "default-deny-outbound",
                  "source": "0.0.0.0/0"
                }
              ]
            }
          ],
          "prefix": "edge",
          "resource_group": "slz-edge-rg",
          "subnets": {
            "zone-1": [
              {
                "acl_name": "edge-acl",
                "cidr": "10.30.10.0/24",
                "name": "vsi-zone-1",
                "public_gateway": true
              },
              {
                "acl_name": "edge-acl",
                "cidr": "10.30.20.0/24",
                "name": "vpe-zone-1",
                "public_gateway": false
              }
            ],
            "zone-2": null,
            "zone-3": null
          },
          "use_public_gateways": {
            "zone-1": true,
            "zone-2": false,
            "zone-3": false
          }
        }
      ],
      "vsi": [
        {
          "boot_volume_encryption_key_name": "slz-vsi-volume-key",
          "image_name": "ibm-sles-15-3-amd64-sap-applications-3",
          "machine_type": "cx2-2x4",
          "name": "jump-box",
          "resource_group": "slz-management-rg",
          "enable_floating_ip": true,
          "security_group": {
            "name": "management",
            "rules": [
              {
                "direction": "inbound",
                "name": "allow-ibm-inbound",
                "source": "161.26.0.0/16"
              },
              {
                "direction": "inbound",
                "name": "allow-vpc-inbound",
                "source": "10.0.0.0/8"
              },
              {
                "direction": "inbound",
                "name": "allow-ibm-tcp-22-inbound",
                "source": "0.0.0.0/0",
                "tcp": {
                  "port_max": 22,
                  "port_min": 22
                }
              },
              {
                "direction": "outbound",
                "name": "allow-all-outbound",
                "source": "0.0.0.0/0"
              }
            ],
            "vpc_name": "management"
          },
          "ssh_keys": [
            "ssh-key"
          ],
          "subnet_names": [
            "vsi-zone-1"
          ],
          "vpc_name": "management",
          "vsi_per_subnet": 1
        },
        {
          "boot_volume_encryption_key_name": "slz-vsi-volume-key",
          "image_name": "ibm-sles-15-3-amd64-sap-applications-3",
          "machine_type": "cx2-2x4",
          "name": "private-svs",
          "resource_group": "slz-workload-rg",
          "enable_floating_ip": false,
          "security_group": {
            "name": "workload",
            "rules": [
              {
                "direction": "inbound",
                "name": "allow-ibm-inbound",
                "source": "161.26.0.0/16"
              },
              {
                "direction": "inbound",
                "name": "allow-vpc-inbound",
                "source": "10.0.0.0/8"
              },
              {
                "direction": "inbound",
                "name": "allow-ibm-udp-53-inbound",
                "source": "0.0.0.0/0",
                "udp": {
                  "port_max": 53,
                  "port_min": 53
                }
              },
              {
                "direction": "outbound",
                "name": "allow-all-outbound",
                "source": "0.0.0.0/0"
              }
            ],
            "vpc_name": "workload"
          },
          "ssh_keys": [
            "ssh-key"
          ],
          "subnet_names": [
            "vsi-zone-1"
          ],
          "vpc_name": "workload",
          "vsi_per_subnet": 1
        },
        {
          "boot_volume_encryption_key_name": "slz-vsi-volume-key",
          "image_name": "ibm-sles-15-3-amd64-sap-applications-3",
          "machine_type": "cx2-2x4",
          "name": "inet-svs",
          "resource_group": "slz-edge-rg",
          "security_group": {
            "name": "inet-svs",
            "rules": [
              {
                "direction": "inbound",
                "name": "allow-ibm-inbound",
                "source": "161.26.0.0/16"
              },
              {
                "direction": "inbound",
                "name": "allow-vpc-inbound",
                "source": "10.0.0.0/8"
              },
              {
                "direction": "inbound",
                "name": "allow-ibm-tcp-80-inbound",
                "source": "0.0.0.0/0",
                "tcp": {
                  "port_max": 80,
                  "port_min": 80
                }
              },
              {
                "direction": "inbound",
                "name": "allow-ibm-tcp-443-inbound",
                "source": "0.0.0.0/0",
                "tcp": {
                  "port_max": 443,
                  "port_min": 443
                }
              },
              {
                "direction": "inbound",
                "name": "allow-ibm-tcp-8443-inbound",
                "source": "0.0.0.0/0",
                "tcp": {
                  "port_max": 8443,
                  "port_min": 8443
                }
              },
              {
                "direction": "inbound",
                "name": "allow-ibm-udp-53-inbound",
                "source": "0.0.0.0/0",
                "udp": {
                  "port_min": 53,
                  "port_max": 53
                }
              },
              {
                "direction": "outbound",
                "name": "allow-all-outbound",
                "source": "0.0.0.0/0"
              }
            ],
            "vpc_name": "edge"
          },
          "ssh_keys": [
            "ssh-key"
          ],
          "subnet_names": [
            "vsi-zone-1"
          ],
          "vpc_name": "edge",
          "vsi_per_subnet": 1
        }
      ],
      "wait_till": "IngressReady"
      }
  - name: ssh_public_key
    description: Public SSH key for VSI
    type: string
    required: true
  - name: powervs_zone
    description: PowerVS location
    type: string
    required: true
  - name: powervs_resource_group_name
    description: PowerVS resource group name
    type: string
    required: true
  - name: ssh_private_key
    description: Private SSH key
    type: string
    required: true
  - name: region
    type: string
    description: Region where VPC landing zone will be created
    optional: true
  - name: ibmcloud_api_key
    type: string
    sensitive: true
    optional: true
  - name: powervs_management_network
    description: Name of the IBM Cloud PowerVS management subnet and CIDR to create.
    optional: true
    type: |
      object({
        name = string
        cidr = string
      })
    default: |
      {
        name = "mgmt_net"
        cidr = "10.51.0.0/24"
      }
  - name: powervs_backup_network
    description: Name of the IBM Cloud PowerVS backup network and CIDR to create.
    optional: true
    type: |
      object({
        name = string
        cidr = string
      })
    default: |
      {
        name = "bkp_net"
        cidr = "10.52.0.0/24"
      }
  - name: reuse_cloud_connections
    description: When true, IBM Cloud connections are reused (if attached to the transit gateway).
    optional: true
    type: bool
    default: false
  - name: configure_proxy
    description: Specify if proxy will be configured. Proxy is mandatory for the landscape, so set this to 'false' only if proxy already exists. Proxy will allow to communcate from IBM PowerVS instances with IBM Cloud network and with public internet.
    required: true
    type: bool
    default: true
  - name: configure_dns_forwarder
    description: Specify if DNS forwarder will be configured. This will allow you to use central DNS servers (e.g. IBM Cloud DNS servers) sitting outside of the created IBM PowerVS infrastructure. If yes, ensure 'dns_forwarder_config' optional variable is set properly.
    required: true
    type: bool
    default: true
  - name: configure_ntp_forwarder
    description: Specify if NTP forwarder will be configured. This will allow you to synchronize time between IBM PowerVS instances. If yes, ensure 'ntp_forwarder_config' optional variable is set properly.
    required: true
    type: bool
    default: true
  - name: configure_nfs_server
    description: Specify if NFS server will be configured. This will allow you easily to share files between PowerVS instances (e.g., SAP installation files). If yes, ensure 'nfs_config' optional variable is set properly.
    required: true
    type: bool
    default: true
  - name: cloud_connection_count
    description: Required number of Cloud connections to create or reuse. The maximum number of connections is two per location.
    optional: true
    type: number
    default: 2
  - name: cloud_connection_speed
    description: Speed in megabits per second. Supported values are 50, 100, 200, 500, 1000, 2000, 5000, 10000. Required when you create a connection.
    optional: true
    type: number
    default: 5000
  - name: tags
    description: Speed in megabits per second. Supported values are 50, 100, 200, 500, 1000, 2000, 5000, 10000. Required when you create a connection.
    optional: true
    type: list(string)
    value: |
      ["sap"]
  - name: cloud_connection_gr
    description: Whether to enable global routing for this IBM Cloud connection. You can specify thia value when you create a connection.
    optional: true
    type: bool
    default: true
  - name: cloud_connection_metered
    description: Whether to enable metering for this IBM Cloud connection. You can specify thia value when you create a connection.
    optional: true
    type: bool
    default: false
  - name: squid_config
    description: Configuration for the Squid proxy to a DNS service that is not reachable directly from PowerVS
    optional: true
    type: |
      object({
        server_host_or_ip = string
        squid_port = string
      })
    default: |
      {
        "server_host_or_ip" = ""
        "squid_port" = ""
      }
  - name: dns_forwarder_config
    description: Configuration for the DNS forwarder to a DNS service that is not reachable directly from PowerVS
    optional: true
    type: |
      object({
        server_host_or_ip = string
        dns_servers = string
      })
    default: |
      {
        "server_host_or_ip" = ""
        "dns_servers" = "161.26.0.7; 161.26.0.8; 9.9.9.9;"
      }
  - name: ntp_forwarder_config
    description: Configuration for the NTP forwarder to an NTP service that is not reachable directly from PowerVS
    optional: true
    type: |
      object({
        server_host_or_ip = string
      })
    default: |
      {
        "server_host_or_ip" = ""
      }
  - name: nfs_config
    description: Configuration for the shared NFS file system (for example, for the installation media).
    optional: true
    type: |
      object({
        server_host_or_ip = string
        nfs_directory     = string
      })
    default: |
      {
        "server_host_or_ip" = ""
        "nfs_directory"    = "/nfs"
      }
  - name: powervs_image_names
    description: List of Images to be imported into cloud account from catalog images
    optional: true
    type: list(string)
    value: ["SLES15-SP3-SAP", "SLES15-SP3-SAP-NETWEAVER", "RHEL8-SP4-SAP", "RHEL8-SP4-SAP-NETWEAVER"]
modules:
  - name: secure-infrastructure
    module_type: terraform
    source:
      source_type: catalog
      catalog:
        catalog_id: "1082e7d2-5e2f-0a11-a3bc-f88a8e1931fc"
        offering_name: "slz-vpc-with-vsis"
        offering_version: "v2.0.0"
        offering_version_flavour_name: "standard"
    inputs:
      - name: ibmcloud_api_key
        value: $blueprint.ibmcloud_api_key
      - name: override_json_string
        value: $blueprint.override_json_string
      - name: prefix
        value: $blueprint.prefix
      - name: region
        value: $blueprint.region
      - name: ssh_public_key
        value: $blueprint.ssh_public_key
    outputs:
      - name: schematics_workspace_id
      - name: config
    settings:
      - name: TF_VERSION
        value: 1.0
  - name: powervs-infrastructure
    layer: infrastructure
    module_type: terraform
    source:
      source_type: catalog
      catalog:
        catalog_id: "1082e7d2-5e2f-0a11-a3bc-f88a8e1931fc"
        offering_id: "07e92c55-6a5b-4f3d-aa0e-30212e108af9"
        offering_name: "terraform-ibm-powervs-catalog-powervs-sap-infrastructure"
        offering_version: "5.4.0-ui"
        offering_version_flavour_name: "standard"
    inputs:
      - name: prerequisite_workspace_id
        value: $module.secure-infrastructure.outputs.schematics_workspace_id
        type: string
      - name: ssh_private_key
        value: $blueprint.ssh_private_key
        type: string
      - name: powervs_zone
        value: $blueprint.powervs_zone
        type: string
      - name: powervs_resource_group_name
        value: $blueprint.powervs_resource_group_name
        type: string
    outputs:
      - name: powervs_workspace_name_id
    settings:
      - name: TF_VERSION
        value: 1.1
